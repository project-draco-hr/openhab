{
  long reconnectionTime=10 * 1000;
  boolean receivedResponse=false;
  try {
    while (!Thread.interrupted()) {
      if (this.channel == null) {
        long connectStartTime=System.currentTimeMillis();
synchronized (this) {
          this.channel=connect();
        }
        if (this.channel == null) {
          this.dispatchEvent(new ConnectionStatusEvent(false));
          Thread.sleep(reconnectionTime - System.currentTimeMillis() + connectStartTime);
          continue;
        }
      }
      SatelCommand command=this.sendQueue.take();
      SatelMessage response=null;
      logger.debug("Sending message: {}",command.getRequest());
      timeoutTimer.start();
      boolean sent=this.writeMessage(command.getRequest());
      timeoutTimer.stop();
      if (sent) {
        command.setState(State.SENT);
        logger.trace("Waiting for response");
        timeoutTimer.start();
        response=this.readMessage();
        timeoutTimer.stop();
        if (response != null) {
          logger.debug("Got response: {}",response);
          if (!receivedResponse) {
            receivedResponse=true;
            this.dispatchEvent(new ConnectionStatusEvent(true));
          }
          if (command.handleResponse(this,response)) {
            command.setState(State.SUCCEEDED);
          }
 else {
            command.setState(State.FAILED);
          }
        }
      }
      if (!sent || response == null) {
        command.setState(State.FAILED);
        break;
      }
    }
  }
 catch (  InterruptedException e) {
  }
catch (  Exception e) {
    logger.info("Unhandled exception occurred in communication loop, disconnecting.",e);
  }
 finally {
    timeoutTimer.stop();
  }
  disconnect();
}

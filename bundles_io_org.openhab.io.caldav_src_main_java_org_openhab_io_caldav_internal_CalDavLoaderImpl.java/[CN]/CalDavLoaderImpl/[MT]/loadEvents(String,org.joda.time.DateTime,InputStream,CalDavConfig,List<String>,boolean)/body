{
  CalendarBuilder builder=new CalendarBuilder();
  BufferedReader in=new BufferedReader(new InputStreamReader(inputStream),50);
  final UnfoldingReader uin=new UnfoldingReader(in,50,true);
  Calendar calendar=builder.build(uin);
  uin.close();
  log.trace("calendar: {}",calendar);
  EventContainer eventContainer=new EventContainer(config.getKey());
  eventContainer.setFilename(filename);
  eventContainer.setLastChanged(lastChanged);
  org.joda.time.DateTime loadFrom=org.joda.time.DateTime.now().minusMinutes(config.getHistoricLoadMinutes());
  org.joda.time.DateTime loadTo=org.joda.time.DateTime.now().plusMinutes(config.getPreloadMinutes());
  final ComponentList<CalendarComponent> vEventComponents=calendar.getComponents(Component.VEVENT);
  if (vEventComponents.size() == 0) {
    if (!readFromFile) {
      Util.storeToDisk(config.getKey(),filename,calendar);
    }
    return;
  }
  for (  CalendarComponent comp : vEventComponents) {
    VEvent vEvent=(VEvent)comp;
    log.trace("loading event: " + vEvent.getUid().getValue() + ":"+ vEvent.getSummary().getValue());
    PeriodList periods=vEvent.calculateRecurrenceSet(new Period(new DateTime(loadFrom.toDate()),new DateTime(loadTo.toDate())));
    String eventId=vEvent.getUid().getValue();
    final String eventName=vEvent.getSummary().getValue();
    if (periods.size() > 0) {
      if (vEvent.getConsumedTime(new net.fortuna.ical4j.model.Date(),new net.fortuna.ical4j.model.Date(org.joda.time.DateTime.now().plusYears(10).getMillis())).size() == 0) {
        log.trace("event will never be occur (historic): {}",eventName);
        eventContainer.setHistoricEvent(true);
      }
    }
    eventContainer.setEventId(eventId);
    eventContainer.setCalculatedUntil(loadTo);
    for (    Period p : periods) {
      org.joda.time.DateTime start=null;
      org.joda.time.DateTime end=null;
      if (p.getStart().getTimeZone() == null) {
        if (p.getStart().isUtc()) {
          log.trace("start is without timezone, but UTC");
          start=new org.joda.time.DateTime(p.getRangeStart(),DateTimeZone.UTC).toLocalDateTime().toDateTime(defaultTimeZone);
        }
 else {
          log.trace("start is without timezone, not UTC");
          start=new LocalDateTime(p.getRangeStart()).toDateTime();
        }
      }
 else       if (DateTimeZone.getAvailableIDs().contains(p.getStart().getTimeZone().getID())) {
        log.trace("start is with known timezone: {}",p.getStart().getTimeZone().getID());
        start=new org.joda.time.DateTime(p.getRangeStart(),DateTimeZone.forID(p.getStart().getTimeZone().getID()));
      }
 else {
        log.trace("start is with unknown timezone: {}",p.getStart().getTimeZone().getID());
        start=new org.joda.time.DateTime(p.getRangeStart(),defaultTimeZone);
      }
      if (p.getEnd().getTimeZone() == null) {
        if (p.getStart().isUtc()) {
          end=new org.joda.time.DateTime(p.getRangeEnd(),DateTimeZone.UTC).toLocalDateTime().toDateTime(defaultTimeZone);
        }
 else {
          end=new LocalDateTime(p.getRangeEnd()).toDateTime();
        }
      }
 else       if (DateTimeZone.getAvailableIDs().contains(p.getEnd().getTimeZone().getID())) {
        end=new org.joda.time.DateTime(p.getRangeEnd(),DateTimeZone.forID(p.getEnd().getTimeZone().getID()));
      }
 else {
        end=new org.joda.time.DateTime(p.getRangeEnd(),defaultTimeZone);
      }
      CalDavEvent event=new CalDavEvent(eventName,vEvent.getUid().getValue(),config.getKey(),start,end);
      event.setLastChanged(lastChanged);
      if (vEvent.getLocation() != null) {
        event.setLocation(vEvent.getLocation().getValue());
      }
      if (vEvent.getDescription() != null) {
        event.setContent(vEvent.getDescription().getValue());
      }
      event.setFilename(filename);
      log.trace("adding event: " + event.getShortName());
      eventContainer.getEventList().add(event);
    }
  }
  addEventToMap(eventContainer,true);
  if (!readFromFile) {
    Util.storeToDisk(config.getKey(),filename,calendar);
  }
}

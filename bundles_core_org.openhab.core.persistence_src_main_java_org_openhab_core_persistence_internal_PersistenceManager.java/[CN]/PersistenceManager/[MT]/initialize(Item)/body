{
  if (item.getState().equals(UnDefType.NULL) && item instanceof GenericItem) {
    for (    Entry<String,List<PersistenceConfiguration>> entry : persistenceConfigurations.entrySet()) {
      String serviceName=entry.getKey();
      PersistenceService service=persistenceServices.get(serviceName);
      if (service instanceof QueryablePersistenceService) {
        QueryablePersistenceService queryService=(QueryablePersistenceService)service;
        for (        PersistenceConfiguration config : entry.getValue()) {
          if (hasStrategy(serviceName,config,GlobalStrategies.RESTORE)) {
            if (appliesToItem(config,item)) {
              FilterCriteria filter=new FilterCriteria().setItemName(item.getName()).setPageSize(1);
              Iterable<HistoricItem> result=queryService.query(filter);
              Iterator<HistoricItem> it=result.iterator();
              if (it.hasNext()) {
                HistoricItem historicItem=it.next();
                GenericItem genericItem=(GenericItem)item;
                genericItem.removeStateChangeListener(this);
                genericItem.setState(historicItem.getState());
                genericItem.addStateChangeListener(this);
                logger.debug("Restored item state from '{}' for item '{}' -> '{}'",new String[]{DateFormat.getDateTimeInstance().format(historicItem.getTimestamp()),item.getName(),historicItem.getState().toString()});
                return;
              }
            }
          }
        }
      }
 else       if (service != null) {
        logger.warn("Failed to restore item states as persistence service '{}' can not be queried.",serviceName);
      }
    }
  }
}

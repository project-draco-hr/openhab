{
  logger.debug("Querying Netatmo API");
  for (  String userid : credentialsCache.keySet()) {
    OAuthCredentials oauthCredentials=getOAuthCredentials(userid);
    if (oauthCredentials.noAccessToken()) {
      oauthCredentials.refreshAccessToken();
    }
    try {
      if (oauthCredentials.firstExecution) {
        processDeviceList(oauthCredentials);
      }
      DeviceMeasureValueMap deviceMeasureValueMap=processMeasurements(oauthCredentials);
      for (      final NetatmoBindingProvider provider : this.providers) {
        for (        final String itemName : provider.getItemNames()) {
          final String deviceId=provider.getDeviceId(itemName);
          final String moduleId=provider.getModuleId(itemName);
          final NetatmoMeasureType measureType=provider.getMeasureType(itemName);
          State state=null;
switch (measureType) {
case MODULENAME:
            if (moduleId == null)             for (            Device device : oauthCredentials.deviceListResponse.getDevices()) {
              if (device.getId().equals(deviceId)) {
                state=new StringType(device.getModuleName());
                break;
              }
            }
 else {
              for (              Module module : oauthCredentials.deviceListResponse.getModules()) {
                if (module.getId().equals(moduleId)) {
                  state=new StringType(module.getModuleName());
                  break;
                }
              }
            }
          break;
case TIMESTAMP:
        state=deviceMeasureValueMap.timeStamp;
      break;
case TEMPERATURE:
case CO2:
case HUMIDITY:
case NOISE:
case PRESSURE:
case RAIN:
    final String requestKey=createKey(deviceId,moduleId);
  BigDecimal value=deviceMeasureValueMap.get(requestKey).get(measureType.getMeasure());
if (value != null) {
  if (measureType == NetatmoMeasureType.TEMPERATURE) {
    value=unitSystem.convertTemp(value);
  }
 else   if (measureType == NetatmoMeasureType.RAIN) {
    value=unitSystem.convertRain(value);
  }
 else   if (measureType == NetatmoMeasureType.PRESSURE) {
    value=pressureUnit.convertPressure(value);
  }
  state=new DecimalType(value);
}
break;
case BATTERYVP:
case RFSTATUS:
for (Module module : oauthCredentials.deviceListResponse.getModules()) {
if (module.getId().equals(moduleId)) {
switch (measureType) {
case BATTERYVP:
  state=new DecimalType(module.getBatteryLevel());
break;
case RFSTATUS:
state=new DecimalType(module.getRfLevel());
break;
case MODULENAME:
state=new StringType(module.getModuleName());
break;
}
}
}
break;
case ALTITUDE:
case LATITUDE:
case LONGITUDE:
case WIFISTATUS:
case COORDINATE:
case STATIONNAME:
for (Device device : oauthCredentials.deviceListResponse.getDevices()) {
if (stationPosition == null) {
stationPosition=new PointType(new DecimalType(device.getLatitude()),new DecimalType(device.getLongitude()),new DecimalType(Math.round(unitSystem.convertAltitude(device.getAltitude()))));
}
if (device.getId().equals(deviceId)) {
switch (measureType) {
case LATITUDE:
state=stationPosition.getLatitude();
break;
case LONGITUDE:
state=stationPosition.getLongitude();
break;
case ALTITUDE:
state=stationPosition.getAltitude();
break;
case WIFISTATUS:
state=new DecimalType(device.getWifiLevel());
break;
case COORDINATE:
state=stationPosition;
break;
case STATIONNAME:
state=new StringType(device.getStationName());
break;
}
}
}
break;
}
if (state != null) {
this.eventPublisher.postUpdate(itemName,state);
}
}
}
}
 catch (NetatmoException ne) {
logger.error(ne.getMessage());
}
}
}

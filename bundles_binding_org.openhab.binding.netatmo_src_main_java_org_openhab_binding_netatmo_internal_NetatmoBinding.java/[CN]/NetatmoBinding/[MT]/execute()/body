{
  logger.debug("Querying Netatmo API");
  for (  String userid : credentialsCache.keySet()) {
    OAuthCredentials oauthCredentials=getOAuthCredentials(userid);
    if (oauthCredentials.noAccessToken()) {
      oauthCredentials.refreshAccessToken();
    }
    try {
      if (oauthCredentials.firstExecution) {
        processDeviceList(oauthCredentials);
      }
      DeviceMeasureValueMap deviceMeasureValueMap=processMeasurements(oauthCredentials);
      for (      final NetatmoBindingProvider provider : this.providers) {
        for (        final String itemName : provider.getItemNames()) {
          final String deviceId=provider.getDeviceId(itemName);
          final String moduleId=provider.getModuleId(itemName);
          final NetatmoMeasureType measureType=provider.getMeasureType(itemName);
          State state=null;
switch (measureType) {
case TIMESTAMP:
            state=deviceMeasureValueMap.timeStamp;
          break;
case TEMPERATURE:
case CO2:
case HUMIDITY:
case NOISE:
case PRESSURE:
case RAIN:
        final String requestKey=createKey(deviceId,moduleId);
      final BigDecimal value=deviceMeasureValueMap.get(requestKey).get(measureType.getMeasure());
    if (value != null) {
      state=new DecimalType(value);
    }
  break;
case BATTERYVP:
case RFSTATUS:
for (Module module : oauthCredentials.deviceListResponse.getModules()) {
  if (module.getId().equals(moduleId)) {
switch (measureType) {
case BATTERYVP:
      state=new DecimalType(module.getBatteryVp());
    break;
case RFSTATUS:
  state=new DecimalType(module.getRfStatus());
break;
}
}
}
break;
case ALTITUDE:
case LATITUDE:
case LONGITUDE:
case WIFISTATUS:
for (Device device : oauthCredentials.deviceListResponse.getDevices()) {
if (device.getId().equals(deviceId)) {
switch (measureType) {
case ALTITUDE:
state=new DecimalType(device.getAltitude());
break;
case LATITUDE:
state=new DecimalType(device.getLatitude());
break;
case LONGITUDE:
state=new DecimalType(device.getLongitude());
break;
case WIFISTATUS:
state=new DecimalType(device.getWifiStatus());
break;
}
}
}
break;
}
if (state != null) {
this.eventPublisher.postUpdate(itemName,state);
}
}
}
}
 catch (NetatmoException ne) {
logger.error(ne.getMessage());
}
}
}

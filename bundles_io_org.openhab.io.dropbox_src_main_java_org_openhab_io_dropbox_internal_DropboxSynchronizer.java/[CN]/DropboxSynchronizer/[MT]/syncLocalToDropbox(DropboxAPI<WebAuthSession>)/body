{
  Map<String,Long> dropboxEntries=new HashMap<String,Long>();
  Entry metadata=dropbox.metadata("/",-1,null,true,null);
  File dropboxEntryFile=new File(contentDir + DROPBOX_ENTRIES_FILE_NAME);
  if (!dropboxEntryFile.exists() || !metadata.hash.equals(lastHash)) {
    collectDropboxEntries(dropbox,dropboxEntries,"/");
    serializeDropboxEntries(dropboxEntryFile,dropboxEntries);
    lastHash=metadata.hash;
  }
 else {
    logger.trace("Dropbox entry file '{}' exists -> extract content",dropboxEntryFile.getPath());
    dropboxEntries=extractDropboxEntries(dropboxEntryFile);
  }
  Map<String,Long> localEntries=new HashMap<String,Long>();
  collectLocalEntries(localEntries,contentDir);
  boolean isChanged=false;
  for (  java.util.Map.Entry<String,Long> entry : localEntries.entrySet()) {
    if (dropboxEntries.containsKey(entry.getKey())) {
      if (entry.getValue().compareTo(dropboxEntries.get(entry.getKey())) > 0) {
        logger.debug("Local file '{}' is newer - upload into Dropbox!",entry.getKey());
        uploadOverwriteFile(entry.getKey());
        isChanged=true;
      }
    }
 else {
      logger.debug("Local file '{}' doesn't exist in Dropbox - upload into Dropbox!",entry.getKey());
      uploadFile(entry.getKey());
      isChanged=true;
    }
    dropboxEntries.remove(entry.getKey());
  }
  for (  String path : dropboxEntries.keySet()) {
    dropbox.delete(path);
    isChanged=true;
    logger.debug("Successfully deleted file '{}' from Dropbox",path);
  }
  if (isChanged) {
    boolean success=FileUtils.deleteQuietly(dropboxEntryFile);
    if (!success) {
      logger.warn("Couldn't delete file '{}'",dropboxEntryFile.getPath());
    }
 else {
      logger.debug("Deleted cache file '{}' since there are changes. It will be recreated while next synchronization loop.",dropboxEntryFile.getPath());
    }
    DeltaPage<Entry> deltaPage=dropbox.delta(lastCursor);
    writeLastCursorFile(deltaPage,new File(contentDir + DELTA_CURSOR_FILE_NAME));
  }
 else {
    logger.debug("There are no deltas to upload into Dropbox ...");
  }
}

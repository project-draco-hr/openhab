{
  org.openhab.core.types.State state=null;
  if (function != null) {
    double result;
switch (function) {
case KWH:
      result=calcEnergy(value,timeElapsed) / 1000;
    result=valueStore.incLatestValue(itemName,result);
  state=new DecimalType(result);
break;
case KWHD:
int currentDay=Calendar.getInstance().get(Calendar.DAY_OF_YEAR);
result=calcEnergy(value,timeElapsed) / 1000;
if (currentDay != lastRecordedDay) {
valueStore.setLatestValue(itemName,result);
lastRecordedDay=currentDay;
}
 else {
result=valueStore.incLatestValue(itemName,result);
}
state=new DecimalType(result);
break;
case CUMULATIVE:
double latestValue=valueStore.getLatestValue(itemName);
if (value < latestValue) {
result=valueStore.incLatestValue(itemName,value);
}
 else {
valueStore.setLatestValue(itemName,value);
}
state=new DecimalType(value);
break;
}
}
 else {
state=new DecimalType(value);
}
return state;
}

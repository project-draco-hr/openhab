{
  org.openhab.core.types.State state=null;
  if (function != null) {
    double result;
switch (function) {
case KWH:
      result=calcEnergy(value.doubleValue(),timeElapsed) / 1000;
    result=incToInternalStoreValue(itemName,result);
  state=new DecimalType(result);
break;
case KWHD:
int currentDay=Calendar.getInstance().get(Calendar.DAY_OF_YEAR);
result=calcEnergy(value.doubleValue(),timeElapsed) / 1000;
if (currentDay != lastRecordedDay) {
valueStore.setValue(itemName,result);
lastRecordedDay=currentDay;
}
 else {
result=incToInternalStoreValue(itemName,result);
}
state=new DecimalType(result);
break;
case CUMULATIVE:
double latestValue=getValueFromInternalStore(itemName);
if (value.doubleValue() < latestValue) {
result=incToInternalStoreValue(itemName,value.doubleValue());
}
 else {
valueStore.setValue(itemName,value.doubleValue());
}
state=new DecimalType(value.doubleValue());
break;
}
}
 else {
state=new DecimalType(value.doubleValue());
}
return state;
}

{
  final HttpServletRequest request=event.getResource().getRequest();
  String transport=request.getHeader("X-Atmosphere-Transport");
  String upgrade=request.getHeader("Upgrade");
  if ((transport == null || transport.isEmpty()) && (upgrade == null || !upgrade.equalsIgnoreCase("websocket"))) {
    event.getResource().resume();
    return;
  }
  stateChangeListener=new StateChangeListener(){
    private volatile Boolean fired=false;
    public void stateUpdated(    Item item,    State state){
    }
    public void stateChanged(    Item item,    State oldState,    State newState){
synchronized (fired) {
        if (!fired) {
          fired=true;
          event.getResource().getBroadcaster().broadcast(getResponseObject(event));
        }
      }
    }
  }
;
  registerStateChangeListenerOnRelevantItems(request,stateChangeListener);
}

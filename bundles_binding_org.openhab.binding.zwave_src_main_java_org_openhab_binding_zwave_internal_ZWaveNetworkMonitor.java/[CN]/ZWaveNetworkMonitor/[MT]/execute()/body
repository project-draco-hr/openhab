{
  if (networkHealDeadCheckNext < System.currentTimeMillis()) {
    for (int nodeId=1; nodeId <= 232; nodeId++) {
      ZWaveNode node=zController.getNode(nodeId);
      if (node == null)       continue;
      if (node.isDead()) {
        logger.debug("NODE {}: DEAD node - requesting network heal.",node.getNodeId());
        zController.requestUpdateNodeRoutes(node.getNodeId());
      }
      node.resetResendCount();
    }
    networkHealDeadCheckNext=System.currentTimeMillis() + networkHealDeadCheckPeriod;
  }
  if (networkHealNightlyTime > System.currentTimeMillis())   return;
  boolean nodeDone=false;
switch (networkHealState) {
case WAITING:
    networkHealState=HealState.UPDATENEIGHBORS;
  break;
case UPDATENEIGHBORS:
networkHealNightlyNode=0;
networkHealState=HealState.UPDATENEIGHBORSNEXT;
case UPDATENEIGHBORSNEXT:
for (; networkHealNightlyNode <= 232; ++networkHealNightlyNode) {
ZWaveNode node=zController.getNode(networkHealNightlyNode);
if (node == null) continue;
logger.debug("NODE {}: Heal is updating node neighbors.");
zController.requestNodeNeighborUpdate(node.getNodeId());
break;
}
networkHealNightlyTime=System.currentTimeMillis() + HEAL_CYCLE_PERIOD;
if (nodeDone == false) {
networkHealState=HealState.UPDATEROUTES;
break;
}
break;
case UPDATEROUTES:
networkHealNightlyNode=0;
networkHealState=HealState.UPDATEROUTESNEXT;
case UPDATEROUTESNEXT:
for (; networkHealNightlyNode <= 232; ++networkHealNightlyNode) {
ZWaveNode node=zController.getNode(networkHealNightlyNode);
if (node == null) continue;
logger.debug("NODE {}: Heal is updating node routes.");
zController.requestUpdateNodeRoutes(node.getNodeId());
break;
}
if (nodeDone == false) {
networkHealState=HealState.GETNEIGHBORS;
break;
}
break;
case GETNEIGHBORS:
networkHealNightlyNode=0;
networkHealState=HealState.GETNEIGHBORSNEXT;
case GETNEIGHBORSNEXT:
for (; networkHealNightlyNode <= 232; ++networkHealNightlyNode) {
ZWaveNode node=zController.getNode(networkHealNightlyNode);
if (node == null) continue;
logger.debug("NODE {}: Heal is requesting node neighbor info.");
zController.requestNodeRoutingInfo(node.getNodeId());
break;
}
if (nodeDone == false) {
networkHealState=HealState.WAITING;
Calendar next=Calendar.getInstance();
next.set(Calendar.HOUR_OF_DAY,networkHealNightlyHour);
next.set(Calendar.MINUTE,0);
next.set(Calendar.SECOND,0);
networkHealNightlyTime=next.getTimeInMillis() + 86400000;
break;
}
break;
}
}

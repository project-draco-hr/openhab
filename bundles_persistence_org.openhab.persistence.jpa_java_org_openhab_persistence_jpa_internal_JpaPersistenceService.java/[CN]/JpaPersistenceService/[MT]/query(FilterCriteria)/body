{
  logger.debug("querying for historic item: " + filter.getItemName());
  if (!initialized) {
    return Collections.emptyList();
  }
  if (!isDbConnectionOpen()) {
    try {
      initializeDbConnection();
    }
 catch (    Exception e) {
      logger.error("Error while initializing database connection!");
      logger.error(e.getMessage());
      return Collections.emptyList();
    }
  }
  String itemName=filter.getItemName();
  Item item=getItemFromRegistry(itemName);
  String entityName;
  if (StateHelper.isOtherStateType(item.getState())) {
    entityName=JpaPersistentOtherItem.class.getSimpleName();
  }
 else {
    entityName=JpaPersistentStringItem.class.getSimpleName();
  }
  String sortOrder;
  if (filter.getOrdering() == Ordering.ASCENDING)   sortOrder="ASC";
 else   sortOrder="DESC";
  boolean hasBeginDate=false;
  boolean hasEndDate=false;
  String queryString="SELECT n FROM " + entityName + " n WHERE n.realName = :itemName";
  if (filter.getBeginDate() != null) {
    queryString+=" AND n.timestamp >= :beginDate";
    hasBeginDate=true;
  }
  if (filter.getEndDate() != null) {
    queryString+=" AND n.timestamp <= :endDate";
    hasEndDate=true;
  }
  queryString+=" ORDER BY n.timestamp " + sortOrder;
  logger.debug("The query: " + queryString);
  try {
    Query query=em.createQuery(queryString);
    query.setParameter("itemName",item.getName());
    if (hasBeginDate)     query.setParameter("beginDate",filter.getBeginDate());
    if (hasEndDate)     query.setParameter("endDate",filter.getEndDate());
    query.setFirstResult(filter.getPageNumber() * filter.getPageSize());
    query.setMaxResults(filter.getPageSize());
    beginTransaction();
    @SuppressWarnings("unchecked") List<JpaPersistentItem> result=(List<JpaPersistentItem>)query.getResultList();
    commitTransaction();
    return JpaHistoricItem.fromResultList(result,item);
  }
 catch (  Exception e) {
    logger.error("Error on querying database!");
    logger.error(e.getMessage());
    rollbackTransaction();
  }
  return Collections.emptyList();
}

{
  return new ResponseHandler<StreamResponseMessage>(){
    public StreamResponseMessage handleResponse(    final HttpResponse httpResponse) throws IOException {
      StatusLine statusLine=httpResponse.getStatusLine();
      if (log.isLoggable(Level.FINE))       log.fine("Received HTTP response: " + statusLine);
      UpnpResponse responseOperation=new UpnpResponse(statusLine.getStatusCode(),statusLine.getReasonPhrase());
      StreamResponseMessage responseMessage=new StreamResponseMessage(responseOperation);
      responseMessage.setHeaders(new UpnpHeaders(HeaderUtil.get(httpResponse)));
      HttpEntity entity=httpResponse.getEntity();
      if (entity == null || entity.getContentLength() == 0) {
        log.fine("HTTP response message has no entity");
        return responseMessage;
      }
      byte data[]=EntityUtils.toByteArray(entity);
      if (data != null) {
        if (responseMessage.isContentTypeMissingOrText()) {
          log.fine("HTTP response message contains text entity");
          responseMessage.setBodyCharacters(data);
        }
 else {
          log.fine("HTTP response message contains binary entity");
          responseMessage.setBody(UpnpMessage.BodyType.BYTES,data);
        }
      }
 else {
        log.fine("HTTP response message has no entity");
      }
      return responseMessage;
    }
  }
;
}

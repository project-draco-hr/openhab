{
  logger.debug("Received incoming chart request: ",req);
  int width=480;
  try {
    width=Integer.parseInt(req.getParameter("w"));
  }
 catch (  Exception e) {
  }
  int height=240;
  try {
    height=Integer.parseInt(req.getParameter("h"));
  }
 catch (  Exception e) {
  }
  Long period=PERIODS.get(req.getParameter("period"));
  if (period == null) {
    period=PERIODS.get("D");
  }
  Chart chart=new ChartBuilder().width(width).height(height).theme(ChartTheme.Matlab).build();
  String serviceName="mysql";
  QueryablePersistenceService service=getPersistenceServices().get(serviceName);
  if (service == null) {
    logger.debug("Persistence service not found '{}'.",serviceName);
    throw new ServletException("Persistence service not found.");
  }
  if (!(service instanceof QueryablePersistenceService)) {
    logger.debug("Persistence service not queryable '{}'.",serviceName);
    throw new ServletException("Persistence service not queryable.");
  }
  Date dateTimeEnd=new Date();
  Date dateTimeBegin=new Date(dateTimeEnd.getTime() - period);
  configureContents(service,dateTimeBegin,dateTimeEnd,chart,req);
  BufferedImage bi=new BufferedImage(chart.getWidth(),chart.getHeight(),BufferedImage.TYPE_INT_RGB);
  res.setContentType("image/png");
  BufferedImage lBufferedImage=new BufferedImage(chart.getWidth(),chart.getHeight(),BufferedImage.TYPE_INT_RGB);
  Graphics2D lGraphics2D=lBufferedImage.createGraphics();
  chart.paint(lGraphics2D);
  ImageIO.write(lBufferedImage,"png",res.getOutputStream());
  javax.imageio.ImageIO.write(bi,"png",res.getOutputStream());
}

{
  logger.debug("Received incoming chart request: ",req);
  int width=defaultWidth;
  try {
    String w=req.getParameter("w");
    if (w != null) {
      Double d=Double.parseDouble(w) * scale;
      width=d.intValue();
    }
  }
 catch (  Exception e) {
  }
  int height=defaultHeight;
  try {
    String h=req.getParameter("h");
    if (h != null) {
      Double d=Double.parseDouble(h) * scale;
      height=d.intValue();
    }
  }
 catch (  Exception e) {
  }
  if (req.getParameter("period") != null && req.getParameter("begin") != null && req.getParameter("end") != null) {
    throw new ServletException("Do not specify the three parameter period, begin and" + "end at the same time.");
  }
  Date timeBegin=null;
  Date timeEnd=null;
  Long period=PERIODS.get(req.getParameter("period"));
  if (period == null && (req.getParameter("begin") == null || req.getParameter("end") == null)) {
    period=PERIODS.get("D");
    logger.debug("Use a day as the period (default period).");
  }
  if (req.getParameter("begin") != null) {
    try {
      timeBegin=dateFormatter.parse(req.getParameter("begin"));
    }
 catch (    ParseException e) {
      throw new ServletException("Begin and end must have this format: " + dateFormat + ".");
    }
  }
  if (req.getParameter("end") != null) {
    try {
      timeEnd=dateFormatter.parse(req.getParameter("end"));
    }
 catch (    ParseException e) {
      throw new ServletException("Begin and end must have this format: " + dateFormat + ".");
    }
  }
  if (timeBegin == null && timeEnd == null) {
    timeEnd=new Date();
    timeBegin=new Date(timeEnd.getTime() - period);
    logger.debug("No begin and end are specified, use now as end and now - period as begin.");
  }
 else   if (timeEnd == null) {
    timeEnd=new Date(timeBegin.getTime() + period);
    logger.debug("No end is specified, use begin + period as end.");
  }
 else   if (timeBegin == null) {
    timeBegin=new Date(timeEnd.getTime() - period);
    logger.debug("No begin is specified, use end - period as begin");
  }
 else   if (timeEnd.before(timeBegin)) {
    throw new ServletException("The end is before the begin.");
  }
  String serviceName=req.getParameter("service");
  ChartProvider provider=getChartProviders().get(providerName);
  if (provider == null)   throw new ServletException("Could not get chart provider.");
  res.setContentType("image/" + provider.getChartType());
  try {
    BufferedImage chart=provider.createChart(serviceName,null,timeBegin,timeEnd,height,width,req.getParameter("items"),req.getParameter("groups"));
    ImageIO.write(chart,provider.getChartType().toString(),res.getOutputStream());
  }
 catch (  ItemNotFoundException e) {
    logger.debug("Item not found error while generating chart.");
  }
catch (  IllegalArgumentException e) {
    logger.debug("Illegal argument in chart: {}",e);
  }
}

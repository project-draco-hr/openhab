{
  if (config != null) {
    Enumeration keys=config.keys();
    while (keys.hasMoreElements()) {
      String key=(String)keys.nextElement();
      if ("service.pid".equals(key)) {
        continue;
      }
      Matcher matcher=EXTRACT_PLUGWISE_CONFIG_PATTERN.matcher(key);
      if (!matcher.matches()) {
        logger.error("given plugwise-config-key '" + key + "' does not follow the expected pattern '<PlugwiseId>.<mac|port>'");
        continue;
      }
      matcher.reset();
      matcher.find();
      String plugwiseID=matcher.group(1);
      if (plugwiseID.equals("stick")) {
        if (stick == null) {
          String configKey=matcher.group(2);
          String value=(String)config.get(key);
          if ("port".equals(configKey)) {
            stick=new Stick(value,this);
            logger.info("Plugwise added Stick connected to serial port {}",value);
          }
 else {
            throw new ConfigurationException(configKey,"the given configKey '" + configKey + "' is unknown");
          }
        }
        if (stick != null) {
          String configKey=matcher.group(2);
          String value=(String)config.get(key);
          if ("interval".equals(configKey)) {
            stick.setInterval(Integer.valueOf(value));
            logger.info("Plugwise set the interval to send ZigBee PDUs to {} ms",value);
          }
 else {
            throw new ConfigurationException(configKey,"the given configKey '" + configKey + "' is unknown");
          }
        }
      }
    }
    if (stick != null) {
      keys=config.keys();
      while (keys.hasMoreElements()) {
        String key=(String)keys.nextElement();
        if ("service.pid".equals(key)) {
          continue;
        }
        Matcher matcher=EXTRACT_PLUGWISE_CONFIG_PATTERN.matcher(key);
        if (!matcher.matches()) {
          logger.error("given plugwise-config-key '" + key + "' does not follow the expected pattern '<PlugwiseId>.<mac|port>'");
          continue;
        }
        matcher.reset();
        matcher.find();
        String plugwiseID=matcher.group(1);
        PlugwiseDevice device=stick.getDeviceByName(plugwiseID);
        if (device == null && !plugwiseID.equals("stick")) {
          String configKey=matcher.group(2);
          String value=(String)config.get(key);
          String MAC=null;
          if ("mac".equals(configKey)) {
            MAC=value;
          }
 else {
            throw new ConfigurationException(configKey,"the given configKey '" + configKey + "' is unknown");
          }
          if (!MAC.equals("")) {
            if (plugwiseID.equals("circleplus")) {
              if (stick.getDeviceByMAC(MAC) == null) {
                device=new CirclePlus(MAC,stick);
                logger.info("Plugwise added Circle+ with MAC address: {}",MAC);
              }
            }
 else {
              if (stick.getDeviceByMAC(MAC) == null) {
                device=new Circle(MAC,stick,plugwiseID);
                logger.info("Plugwise added Circle with MAC address: {}",MAC);
              }
            }
            stick.plugwiseDeviceCache.add(device);
          }
        }
      }
      setProperlyConfigured(true);
    }
 else {
      logger.error("Plugwise needs at least one Stick in order to operate");
    }
  }
}

{
  if (this.initializationComplete) {
    return;
  }
  logger.debug("NODE {}: Node advancer - {}: queue length({}), free to send({})",this.node.getNodeId(),currentStage.toString(),msgQueue.size(),freeToSend);
  if (eventClass == null) {
    freeToSend=true;
  }
  if (sendMessage() == true) {
    return;
  }
  stageAdvanced=false;
  do {
    logger.debug("NODE {}: Node advancer: loop - {}: stageAdvanced({})",this.node.getNodeId(),currentStage.toString(),stageAdvanced);
switch (currentStage) {
case EMPTYNODE:
      logger.debug("NODE {}: Node advancer: Initialisation starting",this.node.getNodeId());
    break;
case PROTOINFO:
  if (eventClass == SerialMessageClass.IdentifyNode) {
    break;
  }
logger.debug("NODE {}: Node advancer: PROTOINFO - send IdentifyNode",this.node.getNodeId());
addToQueue(new IdentifyNodeMessageClass().doRequest(this.node.getNodeId()));
break;
case WAIT:
if (this.node.isListening() == true || this.node.isFrequentlyListening() == true) {
break;
}
logger.debug("NODE {}: Node advancer: WAIT - send IdentifyNode",this.node.getNodeId());
return;
case PING:
if (this.node.getNodeId() == this.controller.getOwnNodeId()) {
logger.debug("NODE {}: Node advancer: PING - Controller - terminating initialisation",this.node.getNodeId());
this.currentStage=NodeStage.DONE;
break;
}
if (eventClass == SerialMessageClass.SendData) {
break;
}
ZWaveNoOperationCommandClass zwaveCommandClass=(ZWaveNoOperationCommandClass)this.node.getCommandClass(CommandClass.NO_OPERATION);
if (zwaveCommandClass == null) {
break;
}
logger.debug("NODE {}: Node advancer: PING - send NoOperation",this.node.getNodeId());
SerialMessage msg=zwaveCommandClass.getNoOperationMessage();
if (msg != null) {
msg.attempts=1;
addToQueue(msg);
}
break;
case DETAILS:
if (this.isRestoredFromConfigfile()) {
logger.debug("NODE {}: Node advancer: Restored from file - skipping static initialisation",this.node.getNodeId());
this.currentStage=NodeStage.SESSION_START;
break;
}
if (eventClass == SerialMessageClass.RequestNodeInfo) {
break;
}
logger.debug("NODE {}: Node advancer: DETAILS - send RequestNodeInfo",this.node.getNodeId());
addToQueue(new RequestNodeInfoMessageClass().doRequest(this.node.getNodeId()));
break;
case MANUFACTURER:
if (this.node.getManufacturer() != Integer.MAX_VALUE && this.node.getDeviceType() != Integer.MAX_VALUE && this.node.getDeviceId() != Integer.MAX_VALUE) {
break;
}
ZWaveManufacturerSpecificCommandClass manufacturerSpecific=(ZWaveManufacturerSpecificCommandClass)this.node.getCommandClass(CommandClass.MANUFACTURER_SPECIFIC);
if (manufacturerSpecific != null) {
logger.debug("NODE {}: Node advancer: MANUFACTURER - send ManufacturerSpecific",this.node.getNodeId());
addToQueue(manufacturerSpecific.getManufacturerSpecificMessage());
}
break;
case VERSION:
ZWaveVersionCommandClass version=(ZWaveVersionCommandClass)this.node.getCommandClass(CommandClass.VERSION);
for (ZWaveCommandClass zwaveVersionClass : this.node.getCommandClasses()) {
logger.debug("NODE {}: Node advancer: VERSION - checking {}, version is {}",this.node.getNodeId(),zwaveVersionClass.getCommandClass().getLabel(),zwaveVersionClass.getVersion());
if (version != null && zwaveVersionClass.getMaxVersion() > 1 && zwaveVersionClass.getVersion() == 0) {
logger.debug("NODE {}: Node advancer: VERSION - queued   {}",this.node.getNodeId(),zwaveVersionClass.getCommandClass().getLabel());
addToQueue(version.checkVersion(zwaveVersionClass));
}
 else {
zwaveVersionClass.setVersion(1);
}
}
logger.debug("NODE {}: Node advancer: VERSION - queued {} frames",this.node.getNodeId(),this.msgQueue.size());
break;
case APP_VERSION:
ZWaveVersionCommandClass versionCommandClass=(ZWaveVersionCommandClass)node.getCommandClass(CommandClass.VERSION);
if (versionCommandClass == null) {
break;
}
if (versionCommandClass.getLibraryType() != LibraryType.LIB_UNKNOWN) {
break;
}
logger.debug("NODE {}: Node advancer: APP_VERSION - send VersionMessage",this.node.getNodeId());
addToQueue(versionCommandClass.getVersionMessage());
break;
case ENDPOINTS:
ZWaveMultiInstanceCommandClass multiInstance=(ZWaveMultiInstanceCommandClass)this.node.getCommandClass(CommandClass.MULTI_INSTANCE);
if (multiInstance != null) {
logger.debug("NODE {}: Node advancer: ENDPOINTS - MultiInstance is supported",this.node.getNodeId());
addToQueue(multiInstance.initEndpoints(stageAdvanced));
logger.debug("NODE {}: Node advancer: ENDPOINTS - queued {} frames",this.node.getNodeId(),this.msgQueue.size());
}
break;
case STATIC_VALUES:
for (ZWaveCommandClass zwaveStaticClass : this.node.getCommandClasses()) {
logger.debug("NODE {}: Node advancer: STATIC_VALUES - checking {}",this.node.getNodeId(),zwaveStaticClass.getCommandClass().getLabel());
if (zwaveStaticClass instanceof ZWaveCommandClassInitialization) {
logger.debug("NODE {}: Node advancer: STATIC_VALUES - found    {}",this.node.getNodeId(),zwaveStaticClass.getCommandClass().getLabel());
ZWaveCommandClassInitialization zcci=(ZWaveCommandClassInitialization)zwaveStaticClass;
int instances=zwaveStaticClass.getInstances();
if (instances == 1) {
addToQueue(zcci.initialize(stageAdvanced));
}
 else {
for (int i=1; i <= instances; i++) {
addToQueue(zcci.initialize(stageAdvanced),zwaveStaticClass,i);
}
}
}
 else if (zwaveStaticClass instanceof ZWaveMultiInstanceCommandClass) {
ZWaveMultiInstanceCommandClass multiInstanceCommandClass=(ZWaveMultiInstanceCommandClass)zwaveStaticClass;
for (ZWaveEndpoint endpoint : multiInstanceCommandClass.getEndpoints()) {
for (ZWaveCommandClass endpointCommandClass : endpoint.getCommandClasses()) {
logger.debug("NODE {}: Node advancer: STATIC_VALUES - checking {} for endpoint {}",this.node.getNodeId(),endpointCommandClass.getCommandClass().getLabel(),endpoint.getEndpointId());
if (endpointCommandClass instanceof ZWaveCommandClassInitialization) {
logger.debug("NODE {}: Node advancer: STATIC_VALUES - found    {}",this.node.getNodeId(),endpointCommandClass.getCommandClass().getLabel());
ZWaveCommandClassInitialization zcci2=(ZWaveCommandClassInitialization)endpointCommandClass;
addToQueue(zcci2.initialize(stageAdvanced),endpointCommandClass,endpoint.getEndpointId());
}
}
}
}
}
logger.debug("NODE {}: Node advancer: STATIC_VALUES - queued {} frames",this.node.getNodeId(),this.msgQueue.size());
break;
case DYNAMIC_VALUES:
for (ZWaveCommandClass zwaveDynamicClass : this.node.getCommandClasses()) {
logger.debug("NODE {}: Node advancer: DYNAMIC_VALUES - checking {}",this.node.getNodeId(),zwaveDynamicClass.getCommandClass().getLabel());
if (zwaveDynamicClass instanceof ZWaveCommandClassDynamicState) {
logger.debug("NODE {}: Node advancer: DYNAMIC_VALUES - found    {}",this.node.getNodeId(),zwaveDynamicClass.getCommandClass().getLabel());
ZWaveCommandClassDynamicState zdds=(ZWaveCommandClassDynamicState)zwaveDynamicClass;
int instances=zwaveDynamicClass.getInstances();
if (instances == 1) {
addToQueue(zdds.getDynamicValues(stageAdvanced));
}
 else {
for (int i=1; i <= instances; i++) {
addToQueue(zdds.getDynamicValues(stageAdvanced),zwaveDynamicClass,i);
}
}
}
 else if (zwaveDynamicClass instanceof ZWaveMultiInstanceCommandClass) {
ZWaveMultiInstanceCommandClass multiInstanceCommandClass=(ZWaveMultiInstanceCommandClass)zwaveDynamicClass;
for (ZWaveEndpoint endpoint : multiInstanceCommandClass.getEndpoints()) {
for (ZWaveCommandClass endpointCommandClass : endpoint.getCommandClasses()) {
logger.debug("NODE {}: Node advancer: DYNAMIC_VALUES - checking {} for endpoint {}",this.node.getNodeId(),endpointCommandClass.getCommandClass().getLabel(),endpoint.getEndpointId());
if (endpointCommandClass instanceof ZWaveCommandClassDynamicState) {
logger.debug("NODE {}: Node advancer: DYNAMIC_VALUES - found    {}",this.node.getNodeId(),endpointCommandClass.getCommandClass().getLabel());
ZWaveCommandClassDynamicState zdds2=(ZWaveCommandClassDynamicState)endpointCommandClass;
addToQueue(zdds2.getDynamicValues(stageAdvanced),endpointCommandClass,endpoint.getEndpointId());
}
}
}
}
}
logger.debug("NODE {}: Node advancer: DYNAMIC_VALUES - queued {} frames",this.node.getNodeId(),this.msgQueue.size());
break;
case NEIGHBORS:
if (eventClass == SerialMessageClass.GetRoutingInfo) {
break;
}
logger.debug("NODE {}: Node advancer: NEIGHBORS - send RoutingInfo",this.node.getNodeId());
addToQueue(new GetRoutingInfoMessageClass().doRequest(this.node.getNodeId()));
break;
case DONE:
initializationComplete=true;
logger.debug("NODE {}: Node advancer: Initialisation complete!",this.node.getNodeId());
case DEAD:
case FAILED:
nodeSerializer.SerializeNode(this.node);
controller.removeEventListener(this);
return;
case SESSION_START:
break;
default :
logger.error("NODE {}: Node advancer: Unknown node state {} encountered.",this.node.getNodeId(),this.node.getNodeStage().toString());
break;
}
if (sendMessage() == false) {
currentStage=currentStage.getNextStage();
stageAdvanced=true;
logger.debug("NODE {}: Node advancer - advancing to {}.",this.node.getNodeId(),currentStage.toString());
queryStageTimeStamp=Calendar.getInstance().getTime();
}
}
 while (msgQueue.isEmpty());
}

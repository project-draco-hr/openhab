{
  if (this.initializationComplete) {
    return;
  }
  if (this.msgQueue.contains(incomingMessage)) {
    logger.debug("NODE {}: Message in initialisation queue.",this.node.getNodeId());
    this.msgQueue.remove(incomingMessage);
  }
  while (msgQueue.isEmpty()) {
    currentStage=currentStage.getNextStage();
    logger.debug("NODE {}: Advancing initialisation to {}.",this.node.getNodeId(),currentStage.getLabel());
    this.node.setQueryStageTimeStamp(Calendar.getInstance().getTime());
    SerialMessage msg;
switch (currentStage) {
case EMPTYNODE:
      if (this.node.getManufacturer() != Integer.MAX_VALUE) {
        this.currentStage=NodeStage.PROTOINFO;
      }
 else {
        try {
          this.controller.identifyNode(this.node.getNodeId());
        }
 catch (        SerialInterfaceException e) {
          logger.error("NODE {}: Got error {}, while identifying node",this.node.getNodeId(),e.getLocalizedMessage());
        }
      }
    break;
case PROTOINFO:
  if (this.node.getNodeId() == this.controller.getOwnNodeId()) {
    this.currentStage=NodeStage.DONE;
    break;
  }
ZWaveNoOperationCommandClass zwaveCommandClass=(ZWaveNoOperationCommandClass)this.node.getCommandClass(CommandClass.NO_OPERATION);
if (zwaveCommandClass == null) {
break;
}
msg=zwaveCommandClass.getNoOperationMessage();
this.msgQueue.add(msg);
this.controller.sendData(msg);
break;
case PING:
case WAKEUP:
if (this.isRestoredFromConfigfile()) {
this.currentStage=NodeStage.DYNAMIC;
break;
}
msg=new RequestNodeInfoMessageClass().doRequest(this.node.getNodeId());
this.msgQueue.add(msg);
this.controller.enqueue(msg);
break;
case DETAILS:
if (this.node.getManufacturer() != Integer.MAX_VALUE && this.node.getDeviceType() != Integer.MAX_VALUE && this.node.getDeviceId() != Integer.MAX_VALUE) {
break;
}
ZWaveManufacturerSpecificCommandClass manufacturerSpecific=(ZWaveManufacturerSpecificCommandClass)this.node.getCommandClass(CommandClass.MANUFACTURER_SPECIFIC);
if (manufacturerSpecific != null) {
msg=manufacturerSpecific.getManufacturerSpecificMessage();
this.msgQueue.add(msg);
this.controller.sendData(msg);
break;
}
break;
case MANSPEC01:
ZWaveVersionCommandClass version=(ZWaveVersionCommandClass)this.node.getCommandClass(CommandClass.VERSION);
for (ZWaveCommandClass zwaveVersionClass : this.node.getCommandClasses()) {
if (version != null && zwaveVersionClass.getMaxVersion() > 1) {
msg=version.checkVersion(zwaveVersionClass);
this.msgQueue.add(msg);
this.controller.sendData(msg);
}
 else {
zwaveVersionClass.setVersion(1);
}
}
break;
case VERSION:
ZWaveMultiInstanceCommandClass multiInstance=(ZWaveMultiInstanceCommandClass)this.node.getCommandClass(CommandClass.MULTI_INSTANCE);
if (multiInstance != null) {
msg=multiInstance.initEndpoints();
this.msgQueue.add(msg);
this.controller.sendData(msg);
}
break;
case INSTANCES_ENDPOINTS:
this.currentStage=NodeStage.STATIC_VALUES;
break;
case STATIC_VALUES:
for (ZWaveCommandClass zwaveStaticClass : this.node.getCommandClasses()) {
logger.trace("NODE {}: Inspecting command class {}",this.node.getNodeId(),zwaveStaticClass.getCommandClass().getLabel());
if (zwaveStaticClass instanceof ZWaveCommandClassInitialization) {
logger.debug("NODE {}: Found initializable command class {}",this.node.getNodeId(),zwaveStaticClass.getCommandClass().getLabel());
ZWaveCommandClassInitialization zcci=(ZWaveCommandClassInitialization)zwaveStaticClass;
int instances=zwaveStaticClass.getInstances();
if (instances == 0) {
Collection<SerialMessage> initqueries=zcci.initialize();
for (SerialMessage serialMessage : initqueries) {
this.msgQueue.add(serialMessage);
this.controller.sendData(serialMessage);
}
}
 else {
for (int i=1; i <= instances; i++) {
Collection<SerialMessage> initqueries=zcci.initialize();
for (SerialMessage serialMessage : initqueries) {
msg=this.node.encapsulate(serialMessage,zwaveStaticClass,i);
this.msgQueue.add(msg);
this.controller.sendData(msg);
}
}
}
}
 else if (zwaveStaticClass instanceof ZWaveMultiInstanceCommandClass) {
ZWaveMultiInstanceCommandClass multiInstanceCommandClass=(ZWaveMultiInstanceCommandClass)zwaveStaticClass;
for (ZWaveEndpoint endpoint : multiInstanceCommandClass.getEndpoints()) {
for (ZWaveCommandClass endpointCommandClass : endpoint.getCommandClasses()) {
logger.trace("NODE {}: Inspecting command class {} for endpoint {}",this.node.getNodeId(),endpointCommandClass.getCommandClass().getLabel(),endpoint.getEndpointId());
if (endpointCommandClass instanceof ZWaveCommandClassInitialization) {
logger.debug("NODE {}: Found initializable command class {}",this.node.getNodeId(),endpointCommandClass.getCommandClass().getLabel());
ZWaveCommandClassInitialization zcci2=(ZWaveCommandClassInitialization)endpointCommandClass;
Collection<SerialMessage> initqueries=zcci2.initialize();
for (SerialMessage serialMessage : initqueries) {
msg=this.node.encapsulate(serialMessage,endpointCommandClass,endpoint.getEndpointId());
this.msgQueue.add(msg);
this.controller.sendData(msg);
}
}
}
}
}
}
break;
case DYNAMIC:
for (ZWaveCommandClass zwaveDynamicClass : this.node.getCommandClasses()) {
logger.trace("NODE {}: Inspecting command class {}",this.node.getNodeId(),zwaveDynamicClass.getCommandClass().getLabel());
if (zwaveDynamicClass instanceof ZWaveCommandClassDynamicState) {
logger.debug("NODE {}: Found dynamic state command class {}",this.node.getNodeId(),zwaveDynamicClass.getCommandClass().getLabel());
ZWaveCommandClassDynamicState zdds=(ZWaveCommandClassDynamicState)zwaveDynamicClass;
int instances=zwaveDynamicClass.getInstances();
if (instances == 0) {
Collection<SerialMessage> dynamicQueries=zdds.getDynamicValues();
for (SerialMessage serialMessage : dynamicQueries) {
this.msgQueue.add(serialMessage);
this.controller.sendData(serialMessage);
}
}
 else {
for (int i=1; i <= instances; i++) {
Collection<SerialMessage> dynamicQueries=zdds.getDynamicValues();
for (SerialMessage serialMessage : dynamicQueries) {
msg=this.node.encapsulate(serialMessage,zwaveDynamicClass,i);
this.msgQueue.add(msg);
this.controller.sendData(msg);
}
}
}
}
 else if (zwaveDynamicClass instanceof ZWaveMultiInstanceCommandClass) {
ZWaveMultiInstanceCommandClass multiInstanceCommandClass=(ZWaveMultiInstanceCommandClass)zwaveDynamicClass;
for (ZWaveEndpoint endpoint : multiInstanceCommandClass.getEndpoints()) {
for (ZWaveCommandClass endpointCommandClass : endpoint.getCommandClasses()) {
logger.trace("NODE {}: Inspecting command class {} for endpoint {}",this.node.getNodeId(),endpointCommandClass.getCommandClass().getLabel(),endpoint.getEndpointId());
if (endpointCommandClass instanceof ZWaveCommandClassDynamicState) {
logger.debug("NODE {}: Found dynamic state command class {}",this.node.getNodeId(),endpointCommandClass.getCommandClass().getLabel());
ZWaveCommandClassDynamicState zdds2=(ZWaveCommandClassDynamicState)endpointCommandClass;
Collection<SerialMessage> dynamicQueries=zdds2.getDynamicValues();
for (SerialMessage serialMessage : dynamicQueries) {
msg=this.node.encapsulate(serialMessage,endpointCommandClass,endpoint.getEndpointId());
this.msgQueue.add(msg);
this.controller.sendData(msg);
}
}
}
}
}
}
break;
case DONE:
initializationComplete=true;
case DEAD:
nodeSerializer.SerializeNode(this.node);
logger.debug("NODE {}: Initialisation complete.",this.node.getNodeId());
break;
default :
logger.error("NODE {}: Unknown node state {} encountered.",this.node.getNodeId(),this.node.getNodeStage().getLabel());
}
}
}

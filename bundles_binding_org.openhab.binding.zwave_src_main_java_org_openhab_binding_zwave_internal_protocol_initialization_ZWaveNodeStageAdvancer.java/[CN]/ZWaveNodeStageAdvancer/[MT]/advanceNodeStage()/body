{
  if (this.initializationComplete) {
    return;
  }
  logger.debug("NODE {}: Node advancer - state {}, queue length {}, free to send {}.",this.node.getNodeId(),currentStage.getLabel(),msgQueue.size(),freeToSend);
  SerialMessage msg;
  if (msgQueue.isEmpty() == false) {
    if (freeToSend == true) {
      try {
        msg=this.msgQueue.take();
        if (msg != null) {
          freeToSend=false;
          controller.sendData(msg);
          logger.debug("NODE {}: Node advancer - queued packet.",this.node.getNodeId());
        }
      }
 catch (      InterruptedException e) {
      }
    }
    return;
  }
  do {
    queryStageTimeStamp=Calendar.getInstance().getTime();
switch (currentStage) {
case EMPTYNODE:
      if (this.node.getManufacturer() != Integer.MAX_VALUE) {
        this.currentStage=NodeStage.PROTOINFO;
      }
 else {
        try {
          this.controller.identifyNode(this.node.getNodeId());
        }
 catch (        SerialInterfaceException e) {
          logger.error("NODE {}: Got error {}, while identifying node",this.node.getNodeId(),e.getLocalizedMessage());
        }
      }
    break;
case PROTOINFO:
  if (this.node.getNodeId() == this.controller.getOwnNodeId()) {
    this.currentStage=NodeStage.DONE;
    break;
  }
ZWaveNoOperationCommandClass zwaveCommandClass=(ZWaveNoOperationCommandClass)this.node.getCommandClass(CommandClass.NO_OPERATION);
if (zwaveCommandClass == null) {
break;
}
msg=zwaveCommandClass.getNoOperationMessage();
this.msgQueue.add(msg);
break;
case PING:
case WAKEUP:
if (this.isRestoredFromConfigfile()) {
this.currentStage=NodeStage.DYNAMIC;
break;
}
msg=new RequestNodeInfoMessageClass().doRequest(this.node.getNodeId());
this.msgQueue.add(msg);
break;
case DETAILS:
if (this.node.getManufacturer() != Integer.MAX_VALUE && this.node.getDeviceType() != Integer.MAX_VALUE && this.node.getDeviceId() != Integer.MAX_VALUE) {
break;
}
ZWaveManufacturerSpecificCommandClass manufacturerSpecific=(ZWaveManufacturerSpecificCommandClass)this.node.getCommandClass(CommandClass.MANUFACTURER_SPECIFIC);
if (manufacturerSpecific != null) {
msg=manufacturerSpecific.getManufacturerSpecificMessage();
this.msgQueue.add(msg);
break;
}
break;
case MANSPEC01:
ZWaveVersionCommandClass version=(ZWaveVersionCommandClass)this.node.getCommandClass(CommandClass.VERSION);
for (ZWaveCommandClass zwaveVersionClass : this.node.getCommandClasses()) {
if (version != null && zwaveVersionClass.getMaxVersion() > 1) {
msg=version.checkVersion(zwaveVersionClass);
this.msgQueue.add(msg);
}
 else {
zwaveVersionClass.setVersion(1);
}
}
break;
case VERSION:
ZWaveMultiInstanceCommandClass multiInstance=(ZWaveMultiInstanceCommandClass)this.node.getCommandClass(CommandClass.MULTI_INSTANCE);
if (multiInstance != null) {
addCollectionToQueue(multiInstance.initEndpoints(stageAdvanced));
}
break;
case INSTANCES_ENDPOINTS:
break;
case STATIC_VALUES:
for (ZWaveCommandClass zwaveStaticClass : this.node.getCommandClasses()) {
logger.trace("NODE {}: Inspecting command class {}",this.node.getNodeId(),zwaveStaticClass.getCommandClass().getLabel());
if (zwaveStaticClass instanceof ZWaveCommandClassInitialization) {
logger.debug("NODE {}: Found initializable command class {}",this.node.getNodeId(),zwaveStaticClass.getCommandClass().getLabel());
ZWaveCommandClassInitialization zcci=(ZWaveCommandClassInitialization)zwaveStaticClass;
int instances=zwaveStaticClass.getInstances();
if (instances == 0) {
addCollectionToQueue(zcci.initialize(stageAdvanced));
}
 else {
for (int i=1; i <= instances; i++) {
addCollectionToQueue(zcci.initialize(stageAdvanced),zwaveStaticClass,i);
}
}
}
 else if (zwaveStaticClass instanceof ZWaveMultiInstanceCommandClass) {
ZWaveMultiInstanceCommandClass multiInstanceCommandClass=(ZWaveMultiInstanceCommandClass)zwaveStaticClass;
for (ZWaveEndpoint endpoint : multiInstanceCommandClass.getEndpoints()) {
for (ZWaveCommandClass endpointCommandClass : endpoint.getCommandClasses()) {
logger.trace("NODE {}: Inspecting command class {} for endpoint {}",this.node.getNodeId(),endpointCommandClass.getCommandClass().getLabel(),endpoint.getEndpointId());
if (endpointCommandClass instanceof ZWaveCommandClassInitialization) {
logger.debug("NODE {}: Found initializable command class {}",this.node.getNodeId(),endpointCommandClass.getCommandClass().getLabel());
ZWaveCommandClassInitialization zcci2=(ZWaveCommandClassInitialization)endpointCommandClass;
addCollectionToQueue(zcci2.initialize(stageAdvanced),endpointCommandClass,endpoint.getEndpointId());
}
}
}
}
}
break;
case DYNAMIC:
for (ZWaveCommandClass zwaveDynamicClass : this.node.getCommandClasses()) {
logger.trace("NODE {}: Inspecting command class {}",this.node.getNodeId(),zwaveDynamicClass.getCommandClass().getLabel());
if (zwaveDynamicClass instanceof ZWaveCommandClassDynamicState) {
logger.debug("NODE {}: Found dynamic state command class {}",this.node.getNodeId(),zwaveDynamicClass.getCommandClass().getLabel());
ZWaveCommandClassDynamicState zdds=(ZWaveCommandClassDynamicState)zwaveDynamicClass;
int instances=zwaveDynamicClass.getInstances();
if (instances == 0) {
addCollectionToQueue(zdds.getDynamicValues(stageAdvanced));
}
 else {
for (int i=1; i <= instances; i++) {
addCollectionToQueue(zdds.getDynamicValues(stageAdvanced),zwaveDynamicClass,i);
}
}
}
 else if (zwaveDynamicClass instanceof ZWaveMultiInstanceCommandClass) {
ZWaveMultiInstanceCommandClass multiInstanceCommandClass=(ZWaveMultiInstanceCommandClass)zwaveDynamicClass;
for (ZWaveEndpoint endpoint : multiInstanceCommandClass.getEndpoints()) {
for (ZWaveCommandClass endpointCommandClass : endpoint.getCommandClasses()) {
logger.trace("NODE {}: Inspecting command class {} for endpoint {}",this.node.getNodeId(),endpointCommandClass.getCommandClass().getLabel(),endpoint.getEndpointId());
if (endpointCommandClass instanceof ZWaveCommandClassDynamicState) {
logger.debug("NODE {}: Found dynamic state command class {}",this.node.getNodeId(),endpointCommandClass.getCommandClass().getLabel());
ZWaveCommandClassDynamicState zdds2=(ZWaveCommandClassDynamicState)endpointCommandClass;
addCollectionToQueue(zdds2.getDynamicValues(stageAdvanced),endpointCommandClass,endpoint.getEndpointId());
}
}
}
}
}
break;
case DONE:
initializationComplete=true;
case DEAD:
nodeSerializer.SerializeNode(this.node);
logger.debug("NODE {}: Node advancer - initialisation complete.",this.node.getNodeId());
break;
default :
logger.error("NODE {}: Unknown node state {} encountered.",this.node.getNodeId(),this.node.getNodeStage().getLabel());
}
stageAdvanced=false;
if (msgQueue.isEmpty()) {
currentStage=currentStage.getNextStage();
stageAdvanced=true;
logger.debug("NODE {}: Node advancer - advancing to {}.",this.node.getNodeId(),currentStage.getLabel());
}
 else {
try {
freeToSend=false;
controller.sendData(this.msgQueue.take());
}
 catch (InterruptedException e) {
}
logger.debug("NODE {}: Node advancer - queued packet.",this.node.getNodeId());
}
}
 while (msgQueue.isEmpty());
}

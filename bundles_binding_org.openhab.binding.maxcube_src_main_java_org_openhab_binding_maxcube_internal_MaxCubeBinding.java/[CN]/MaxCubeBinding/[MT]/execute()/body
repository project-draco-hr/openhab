{
  Socket socket=null;
  BufferedReader reader=null;
  try {
    String raw=null;
    socket=new Socket(ip,port);
    reader=new BufferedReader(new InputStreamReader(socket.getInputStream()));
    boolean cont=true;
    while (cont) {
      raw=reader.readLine();
      if (raw == null) {
        cont=false;
        continue;
      }
      Message message;
      try {
        message=processRawMessage(raw);
        message.debug(logger);
        if (message != null) {
          if (message.getType() == MessageType.M) {
            M_Message msg=(M_Message)message;
            for (            DeviceInformation di : msg.devices) {
              Configuration c=null;
              for (              Configuration conf : configurations) {
                if (conf.getSerialNumber().equalsIgnoreCase(di.getSerialNumber())) {
                  c=conf;
                  break;
                }
              }
              if (c != null) {
                configurations.remove(c);
              }
              c=Configuration.create(di);
              configurations.add(c);
              c.setRoomId(di.getRoomId());
            }
          }
 else           if (message.getType() == MessageType.C) {
            Configuration c=null;
            for (            Configuration conf : configurations) {
              if (conf.getSerialNumber().equalsIgnoreCase(((C_Message)message).getSerialNumber())) {
                c=conf;
                break;
              }
            }
            if (c == null) {
              configurations.add(Configuration.create(message));
            }
 else {
              c.setValues((C_Message)message);
            }
          }
 else           if (message.getType() == MessageType.L) {
            Collection<? extends Device> tempDevices=((L_Message)message).getDevices(configurations);
            for (            Device d : tempDevices) {
              Device existingDevice=findDevice(d.getSerialNumber(),devices);
              if (existingDevice == null) {
                devices.add(d);
              }
 else {
                devices.remove(existingDevice);
                devices.add(d);
              }
            }
            logger.info(devices.size() + " devices found.");
            cont=false;
          }
        }
      }
 catch (      Exception e) {
        logger.info("Failed to process message received by MAX! protocol.");
        logger.debug(Utils.getStackTrace(e));
      }
    }
    socket.close();
    for (    MaxCubeBindingProvider provider : providers) {
      for (      String itemName : provider.getItemNames()) {
        String serialNumber=provider.getSerialNumber(itemName);
        Device device=findDevice(serialNumber,devices);
        if (device == null) {
          logger.info("Cannot find MAX!cube device with serial number '{}'",serialNumber);
          if (logger.isDebugEnabled()) {
            StringBuilder sb=new StringBuilder();
            sb.append("Available MAX! devices are:");
            for (            Device d : devices) {
              sb.append("\n\t");
              sb.append(d.getSerialNumber());
            }
            logger.debug(sb.toString());
          }
          continue;
        }
switch (device.getType()) {
case HeatingThermostat:
          if (provider.getBindingType(itemName) == BindingType.VALVE) {
            eventPublisher.postUpdate(itemName,((HeatingThermostat)device).getValvePosition());
          }
 else           if (provider.getBindingType(itemName) == BindingType.BATTERY) {
            eventPublisher.postUpdate(itemName,((HeatingThermostat)device).getBatteryLow());
          }
 else {
            eventPublisher.postUpdate(itemName,((HeatingThermostat)device).getTemperatureSetpoint());
          }
        break;
case ShutterContact:
      if (provider.getBindingType(itemName) == BindingType.BATTERY) {
        eventPublisher.postUpdate(itemName,((ShutterContact)device).getBatteryLow());
      }
 else {
        eventPublisher.postUpdate(itemName,((ShutterContact)device).getShutterState());
      }
    break;
case WallMountedThermostat:
  eventPublisher.postUpdate(itemName,((WallMountedThermostat)device).getTemperatureSetpoint());
break;
default :
}
}
}
}
 catch (UnknownHostException e) {
logger.info("Cannot establish connection with MAX!Cube lan gateway while connecting to '{}'",ip);
logger.debug(Utils.getStackTrace(e));
}
catch (IOException e) {
logger.info("Cannot read data from MAX!Cube lan gateway while connecting to '{}'",ip);
logger.debug(Utils.getStackTrace(e));
}
}

{
  logger.trace("Handle Message Sensor Alarm Request");
  logger.debug(String.format("Received Sensor Alarm Request for Node ID = %d",this.getNode().getNodeId()));
  int command=serialMessage.getMessagePayloadByte(offset);
switch (command) {
case SENSOR_ALARM_GET:
case SENSOR_ALARM_SUPPORTED_GET:
    logger.warn(String.format("Command 0x%02X not implemented.",command));
  return;
case SENSOR_ALARM_REPORT:
logger.trace("Process Sensor Alarm Report");
int sourceNode=serialMessage.getMessagePayloadByte(offset + 1);
int alarmTypeCode=serialMessage.getMessagePayloadByte(offset + 2);
int value=serialMessage.getMessagePayloadByte(offset + 3);
logger.debug("NODE {}: Sensor Alarm report, source {}, value {}",this.getNode().getNodeId(),sourceNode,value);
AlarmType alarmType=AlarmType.getAlarmType(alarmTypeCode);
if (alarmType == null) {
logger.error("NODE {}: Unknown Alarm Type = {}, ignoring report.",this.getNode().getNodeId(),alarmTypeCode);
return;
}
Alarm alarm=alarms.get(alarmType);
if (alarm == null) {
alarm=new Alarm(alarmType);
this.alarms.put(alarmType,alarm);
}
alarm.setInitialised();
logger.debug("NODE {}: Alarm Report, Type = {} ({}), Value = {}",this.getNode().getNodeId(),alarmType.getLabel(),alarmTypeCode,value);
ZWaveAlarmSensorValueEvent zEvent=new ZWaveAlarmSensorValueEvent(this.getNode().getNodeId(),endpoint,alarmType,value);
this.getController().notifyEventListeners(zEvent);
break;
case SENSOR_ALARM_SUPPORTED_REPORT:
logger.debug("NODE {}: Process Sensor Supported Alarm Report",this.getNode().getNodeId());
int numBytes=serialMessage.getMessagePayloadByte(offset + 1);
int manufacturerId=this.getNode().getManufacturer();
int deviceType=this.getNode().getDeviceType();
if (manufacturerId == 0x010F && deviceType == 0x0700) {
logger.warn("Detected Fibaro FGK - 101 Door / Window sensor, activating workaround for incorrect encoding of supported alarm bitmap.");
for (int i=0; i < numBytes; ++i) {
int index=serialMessage.getMessagePayloadByte(offset + i + 2);
if (index >= AlarmType.values().length) continue;
AlarmType alarmTypeToAdd=AlarmType.getAlarmType(index);
Alarm newAlarm=new Alarm(alarmTypeToAdd);
this.alarms.put(alarmTypeToAdd,newAlarm);
logger.debug("NODE {}: Added alarm type {} ({})",this.getNode().getNodeId(),alarmTypeToAdd.getLabel(),index);
}
}
 else {
for (int i=0; i < numBytes; ++i) {
for (int bit=0; bit < 8; ++bit) {
if (((serialMessage.getMessagePayloadByte(offset + i + 2)) & (1 << bit)) == 0) {
continue;
}
int index=(i << 3) + bit;
if (index >= AlarmType.values().length) {
continue;
}
AlarmType alarmTypeToAdd=AlarmType.getAlarmType(index);
Alarm newAlarm=new Alarm(alarmTypeToAdd);
this.alarms.put(alarmTypeToAdd,newAlarm);
logger.debug("NODE {}: Added alarm type {} ({})",this.getNode().getNodeId(),alarmTypeToAdd.getLabel(),index);
}
}
}
initialiseDone=true;
break;
default :
logger.warn(String.format("Unsupported Command 0x%02X for command class %s (0x%02X).",command,this.getCommandClass().getLabel(),this.getCommandClass().getKey()));
}
}

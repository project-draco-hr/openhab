{
  String label=null;
  if (w.getLabel() != null) {
    label=w.getLabel();
  }
 else {
    String itemName=w.getItem();
    if (itemName != null) {
      if (delegatingItemUIProvider != null) {
        label=delegatingItemUIProvider.getLabel(itemName);
      }
      if (label == null)       label=itemName;
    }
  }
  if (label == null)   label="";
  String itemName=w.getItem();
  if (itemName != null && label.contains("[")) {
    int indexOpenBracket=label.indexOf("[");
    int indexCloseBracket=label.indexOf("]");
    if (itemRegistry != null) {
      State state=null;
      String formatPattern=label.substring(indexOpenBracket + 1,indexCloseBracket);
      try {
        Item item=itemRegistry.getItem(itemName);
        if (label.contains("%s")) {
          state=item.getState();
        }
 else         if (label.contains("%t") || label.contains("%1$t")) {
          state=item.getState();
        }
 else {
          state=item.getStateAs(DecimalType.class);
        }
      }
 catch (      ItemNotFoundException e) {
        logger.error("Cannot retrieve item for widget {}",w.eClass().getInstanceTypeName());
      }
catch (      ItemNotUniqueException e) {
        logger.error("Item with name '{}' is not unique.",itemName,e);
      }
      if (state == null || state instanceof UnDefType) {
        if (label.contains("%s")) {
          formatPattern=String.format(formatPattern,"undefined");
        }
 else         if (label.contains("%t") || label.contains("%1$t")) {
          formatPattern=String.format(formatPattern,Calendar.getInstance());
        }
 else         if (label.contains("%d")) {
          formatPattern=String.format(formatPattern,0);
        }
 else {
          formatPattern=String.format(formatPattern,0f);
        }
      }
 else       if (state instanceof PrimitiveType) {
        formatPattern=((PrimitiveType)state).format(formatPattern);
      }
      label=label.substring(0,indexOpenBracket + 1) + formatPattern + label.substring(indexCloseBracket);
    }
  }
  if (label.contains("[") && label.endsWith("]")) {
    Matcher matcher=EXTRACT_TRANSFORMFUNCTION_PATTERN.matcher(label);
    if (matcher.find()) {
      String type=matcher.group(1);
      String pattern=matcher.group(2);
      String value=matcher.group(3);
      TransformationService transformation=TransformationHelper.getTransformationService(WebAppActivator.getContext(),type);
      if (transformation != null) {
        try {
          label=label.substring(0,label.indexOf("[") + 1) + transformation.transform(pattern,value) + "]";
        }
 catch (        TransformationException e) {
          logger.error("transformation throws exception [transformation=" + transformation + ", value="+ value+ "]",e);
          label=label.substring(0,label.indexOf("[") + 1) + value + "]";
        }
      }
 else {
        logger.warn("couldn't transform value in label because transformationService of type '{}' is unavailable",type);
        label=label.substring(0,label.indexOf("[") + 1) + value + "]";
      }
    }
    label=label.replaceAll("\\[","<span>").replaceAll("\\]","</span>");
  }
  return label;
}

{
  if (message != null) {
    if (message.getAttempts() < theStick.maxRetries) {
      message.increaseAttempts();
      String packedString=PROTOCOL_HEADER + message.toHexString() + PROTOCOL_TRAILER;
      ByteBuffer bytebuffer=ByteBuffer.allocate(packedString.length());
      bytebuffer.put(packedString.getBytes());
      bytebuffer.rewind();
      theStick.queueLock.lock();
      try {
        logger.debug("Sending: {} as {}",message,message.toHexString());
        theStick.outputChannel.write(bytebuffer);
      }
 catch (      IOException e) {
        logger.error("Error writing '{}' to serial port {}: {}",packedString,theStick.port,e.getMessage());
      }
      Message lastMessage=null;
      while (lastMessage == null) {
        theStick.receiveLock.lock();
        Iterator<Message> messageIterator=theStick.receivedQueue.iterator();
        while (messageIterator.hasNext()) {
          Message aMessage=messageIterator.next();
          if (aMessage.getType().equals(MessageType.ACKNOWLEDGEMENT)) {
            if (!((AcknowledgeMessage)aMessage).isExtended()) {
              lastMessage=aMessage;
              logger.debug("Removing from receivedQueue: {}",lastMessage);
              theStick.receivedQueue.remove(lastMessage);
              break;
            }
          }
        }
        theStick.receiveLock.unlock();
      }
      AcknowledgeMessage ack=(AcknowledgeMessage)lastMessage;
      if (!ack.isSuccess()) {
        if (ack.isError()) {
          logger.error("Error sending: Negative ACK: {}",packedString);
        }
      }
 else {
        message.setSequenceNumber(ack.getSequenceNumber());
        try {
          logger.debug("Adding to sentQueue: {}",message);
          if (theStick.sentQueue.size() == maxBufferSize) {
            Message someMessage=theStick.sentQueue.poll();
            logger.debug("Flushing from sentQueue: {}",someMessage);
          }
          theStick.sentQueue.put(message);
        }
 catch (        InterruptedException e) {
          logger.error("Interrupted while adding to sentQueue: {}",message);
        }
      }
      theStick.queueLock.unlock();
      return true;
    }
 else {
      logger.error("Giving finally up on Plugwise protocol data unit after attempts: {} MAC:{} command:{} sequence:{} payload:{}",message.getAttempts(),message.getMAC(),message.getType(),message.getSequenceNumber(),message.getPayLoad());
    }
  }
  return false;
}

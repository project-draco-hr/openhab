{
  if ((ip != null && !ip.isEmpty()) || (serialPort != null && !serialPort.isEmpty())) {
    try {
      if (ip != null) {
        InetSocketAddress localEndPoint=null;
        if (localIp != null && !localIp.isEmpty()) {
          localEndPoint=new InetSocketAddress(localIp,0);
        }
 else {
          localEndPoint=new InetSocketAddress(InetAddress.getLocalHost(),0);
        }
        link=new KNXNetworkLinkIP(KNXNetworkLinkIP.TUNNEL,localEndPoint,new InetSocketAddress(ip,port),false,TPSettings.TP1);
      }
 else {
        try {
          RXTXVersion.getVersion();
          link=new KNXNetworkLinkFT12(serialPort,new TPSettings(true));
        }
 catch (        NoClassDefFoundError e) {
          throw new KNXException("The serial FT1.2 KNX connection requires the serial binding to be installed!");
        }
catch (        KNXException e) {
          if (e.getMessage().startsWith("can not open serial port")) {
            StringBuilder sb=new StringBuilder("Available ports are:\n");
            Enumeration portList=CommPortIdentifier.getPortIdentifiers();
            while (portList.hasMoreElements()) {
              CommPortIdentifier id=(CommPortIdentifier)portList.nextElement();
              if (id.getPortType() == CommPortIdentifier.PORT_SERIAL) {
                sb.append(id.getName() + "\n");
              }
            }
            sb.deleteCharAt(sb.length() - 1);
            e=new KNXException("Serial port '" + serialPort + "' could not be opened. "+ sb.toString());
          }
          throw e;
        }
      }
      link.addLinkListener(new NetworkLinkListener(){
        public void linkClosed(        CloseEvent e){
          if (!e.isUserRequest()) {
            logger.warn("KNX link has been lost (reason: {} on object {}) - reconnecting...",e.getReason(),e.getSource().toString());
            connect();
          }
          if (!link.isOpen()) {
            logger.error("KNX link has been lost!");
          }
        }
        public void indication(        FrameEvent e){
        }
        public void confirmation(        FrameEvent e){
        }
      }
);
      if (pc != null) {
        pc.removeProcessListener(listener);
        pc.detach();
      }
      pc=new ProcessCommunicatorImpl(link);
      pc.setResponseTimeout(10);
      if (listener != null) {
        pc.addProcessListener(listener);
      }
      if (ip != null) {
        logger.info("Established connection to KNX bus on {}.",ip + ":" + port);
      }
 else {
        logger.info("Established connection to KNX bus through FT1.2 on serial port {}.",serialPort);
      }
    }
 catch (    KNXException e) {
      logger.error("Error connecting to KNX bus",e);
    }
catch (    UnknownHostException e) {
      logger.error("Error connecting to KNX bus",e);
    }
  }
 else {
    logger.error("No IP address or serial port could be found in configuration!");
  }
}

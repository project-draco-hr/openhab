{
  String snippetName;
  if (w instanceof Switch) {
    Item item;
    try {
      item=service.getItemRegistry().getItem(service.getItem(w));
      if (item instanceof RollershutterItem) {
        snippetName="rollerblind";
      }
 else {
        snippetName="switch";
      }
    }
 catch (    ItemNotFoundException e) {
      logger.warn("Cannot determine item type of '{}'",service.getItem(w),e);
      snippetName="switch";
    }
catch (    ItemNotUniqueException e) {
      logger.warn("Cannot determine item type of '{}'",service.getItem(w),e);
      snippetName="switch";
    }
  }
 else {
    snippetName=w.eClass().getInstanceTypeName().substring(w.eClass().getInstanceTypeName().lastIndexOf(".") + 1);
  }
  if (!(w instanceof Frame || w instanceof Group) && (w instanceof LinkableWidget) && ((LinkableWidget)w).getChildren().size() > 0) {
    snippetName+="_link";
  }
  String snippet=service.getSnippet(snippetName);
  snippet=snippet.replaceAll("%id%",service.getWidgetId(w));
  snippet=snippet.replaceAll("%icon%",service.getIcon(w));
  snippet=snippet.replaceAll("%item%",service.getItem(w));
  snippet=snippet.replaceAll("%label%",service.getLabel(w));
  snippet=snippet.replaceAll("%servletname%",SERVLET_NAME);
  if (w instanceof Switch) {
    State state=service.getState(w);
    if (state.equals(OnOffType.ON)) {
      snippet=snippet.replaceAll("%checked%","checked=true");
    }
 else {
      snippet=snippet.replaceAll("%checked%","");
    }
  }
  if (w instanceof Image) {
    snippet=snippet.replaceAll("%url%",((Image)w).getUrl());
  }
  if (w instanceof List) {
    String rowSnippet=service.getSnippet("list_row");
    String state=service.getState(w).toString();
    String[] rowContents=state.split(((List)w).getSeparator());
    StringBuilder rowSB=new StringBuilder();
    for (    String row : rowContents) {
      rowSB.append(rowSnippet.replace("%title%",row));
    }
    snippet=snippet.replace("%rows%",rowSB.toString());
  }
  if (w instanceof Selection) {
    String state=service.getState(w).toString();
    String[] labels=service.getLabel(w).split(";");
    if (labels.length > 0) {
      snippet=snippet.replace("%label_header%",labels[0]);
      StringBuilder rowSB=new StringBuilder();
      for (int i=1; i < labels.length; i++) {
        String valuelabel=labels[i];
        String rowSnippet=service.getSnippet("selection_row");
        String value=StringUtils.substringBefore(valuelabel,"=");
        String label=StringUtils.substringAfter(valuelabel,"=");
        rowSnippet=rowSnippet.replace("%item%",service.getItem(w));
        rowSnippet=rowSnippet.replace("%value%",value);
        rowSnippet=rowSnippet.replace("%label%",label);
        if (value.equals(state)) {
          rowSnippet=rowSnippet.replace("%checked%","checked=\"true\"");
        }
 else {
          rowSnippet=rowSnippet.replace("%checked%","");
        }
        rowSB.append(rowSnippet);
      }
      snippet=snippet.replace("%rows%",rowSB.toString());
    }
  }
  if (w instanceof Frame) {
    processChildren(snippet,sb,service.getChildren((Frame)w));
  }
 else {
    sb.append(snippet);
  }
}

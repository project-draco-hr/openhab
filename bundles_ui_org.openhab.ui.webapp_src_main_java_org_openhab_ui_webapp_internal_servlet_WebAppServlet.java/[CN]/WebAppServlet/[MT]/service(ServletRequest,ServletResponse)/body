{
  logger.debug("Servlet request received!");
  String sitemapName=(String)req.getParameter("sitemap");
  String widgetId=(String)req.getParameter("w");
  boolean async="true".equalsIgnoreCase((String)req.getParameter("__async"));
  if (sitemapName == null)   sitemapName="default";
  StringBuilder sb=new StringBuilder();
  Sitemap sitemap=service.getSitemapProvider().getSitemap(sitemapName);
  if (sitemap != null) {
    logger.debug("reading sitemap {}",sitemap.getName());
    if (widgetId == null) {
      String label=sitemap.getLabel() != null ? sitemap.getLabel() : sitemapName;
      processPage("Home",sitemapName,label,sitemap.getChildren(),async,sb);
    }
 else {
      Widget w=service.getWidget(sitemap,widgetId);
      String label=service.getLabel(w);
      if (label == null)       label="undefined";
      if (w instanceof LinkableWidget) {
        EList<Widget> children=service.getChildren((LinkableWidget)w);
        processPage(service.getWidgetId(w),sitemapName,label,children,async,sb);
      }
 else {
        throw new ServletException("Widget '" + w + "' can not have any content");
      }
    }
  }
 else {
    throw new ServletException("Sitemap '" + sitemapName + "' could not be found");
  }
  if (async) {
    res.setContentType("application/xml;charset=UTF-8");
  }
 else {
    res.setContentType("text/html;charset=UTF-8");
  }
  res.getWriter().append(sb);
  res.getWriter().close();
}

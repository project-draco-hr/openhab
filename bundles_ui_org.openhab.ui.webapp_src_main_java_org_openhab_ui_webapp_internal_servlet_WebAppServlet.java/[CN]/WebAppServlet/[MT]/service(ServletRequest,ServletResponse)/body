{
  logger.debug("Servlet request received!");
  String sitemapName=(String)req.getParameter("sitemap");
  String widgetId=(String)req.getParameter("w");
  boolean async="true".equalsIgnoreCase((String)req.getParameter("__async"));
  boolean poll="true".equalsIgnoreCase((String)req.getParameter("poll"));
  if (sitemapName == null)   sitemapName="default";
  StringBuilder result=new StringBuilder();
  Sitemap sitemap=service.getSitemapProvider().getSitemap(sitemapName);
  if (sitemap != null) {
    logger.debug("reading sitemap {}",sitemap.getName());
    if (widgetId == null || widgetId.isEmpty() || widgetId.equals("Home")) {
      String label=sitemap.getLabel() != null ? sitemap.getLabel() : sitemapName;
      EList<Widget> children=sitemap.getChildren();
      if (poll) {
        if (waitForChanges(children) == false) {
          res.getWriter().append(getTimeoutResponse()).close();
          return;
        }
      }
      result.append(renderer.processPage("Home",sitemapName,label,sitemap.getChildren(),async));
    }
 else {
      Widget w=service.getWidget(sitemap,widgetId);
      String label=service.getLabel(w);
      if (label == null)       label="undefined";
      if (w instanceof LinkableWidget) {
        EList<Widget> children=service.getChildren((LinkableWidget)w);
        if (poll) {
          if (waitForChanges(children) == false) {
            res.getWriter().append(getTimeoutResponse()).close();
            return;
          }
        }
        result.append(renderer.processPage(service.getWidgetId(w),sitemapName,label,children,async));
      }
 else {
        throw new ServletException("Widget '" + w + "' can not have any content");
      }
    }
  }
 else {
    throw new ServletException("Sitemap '" + sitemapName + "' could not be found");
  }
  if (async) {
    res.setContentType("application/xml;charset=UTF-8");
  }
 else {
    res.setContentType("text/html;charset=UTF-8");
  }
  res.getWriter().append(result);
  res.getWriter().close();
}

{
  String label=null;
  if (w.getLabel() != null) {
    label=w.getLabel();
  }
 else {
    String itemName=getItem(w);
    if (itemName != null) {
      label=delegatingItemUIProvider.getLabel(itemName);
      if (label == null)       label=itemName;
    }
  }
  if (label == null)   label="";
  String itemName=getItem(w);
  if (itemName != null && label.contains("%")) {
    try {
      Item item=getItemRegistry().getItem(itemName);
      State state=item.getState();
      if (state instanceof DecimalType) {
        label=((DecimalType)state).format(label);
      }
      if (state instanceof StringType) {
        label=((StringType)state).format(label);
      }
      if (state instanceof UnDefType) {
        if (label.contains("%s")) {
          label=String.format(label,"undefined");
        }
 else {
          label=String.format(label,0f);
        }
      }
    }
 catch (    ItemNotFoundException e) {
      logger.error("Cannot retrieve item for widget {}",w.eClass().getInstanceTypeName());
    }
catch (    ItemNotUniqueException e) {
      logger.error("Item with name '{}' is not unique.",itemName,e);
    }
  }
  if (label.contains("[") && label.endsWith("]")) {
    label=label.replaceAll("\\[","<span>").replaceAll("\\]","</span>");
  }
  return label;
}

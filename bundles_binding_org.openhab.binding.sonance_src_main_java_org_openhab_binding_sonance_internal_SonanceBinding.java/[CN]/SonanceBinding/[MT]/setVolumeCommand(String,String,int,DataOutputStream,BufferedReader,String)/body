{
  char[] cbuf=new char[50];
  String lockKey=endpoint + ":" + group;
  if (!volumeLocks.containsKey(lockKey)) {
    volumeLocks.put(lockKey,new ReentrantLock());
  }
  try {
    volumeLocks.get(lockKey).tryLock(2,TimeUnit.SECONDS);
  }
 catch (  InterruptedException e) {
    logger.debug("Lock waiting time (2s) expired for lockKey {}.",lockKey);
    return;
  }
  try {
    outToServer.write(hexStringToByteArray(SonanceConsts.VOLUME_QUERY + group));
    i.read(cbuf,0,50);
    Matcher m=volumePattern.matcher(new String(cbuf));
    if (m.find()) {
      double currentVolume=Integer.parseInt(m.group(1));
      eventPublisher.postUpdate(itemName,new DecimalType(currentVolume));
      logger.debug("Updating {} with new volume {}",itemName,currentVolume);
      int step=0;
      while (currentVolume != targetVolume && step++ <= 28) {
        logger.debug("Current volume: {}, target volume: {}, step: {}, lock: {})",currentVolume,targetVolume,step,lockKey);
        if (currentVolume + 3 <= targetVolume) {
          outToServer.write(hexStringToByteArray(SonanceConsts.VOLUME_UP_3 + group));
          logger.debug("Sending volume up 3 command {}",SonanceConsts.VOLUME_UP_3);
        }
        if (currentVolume - 3 >= targetVolume) {
          outToServer.write(hexStringToByteArray(SonanceConsts.VOLUME_DOWN_3 + group));
          logger.debug("Sending volume down 3 command {}",SonanceConsts.VOLUME_DOWN_3);
        }
 else         if (currentVolume < targetVolume) {
          outToServer.write(hexStringToByteArray(SonanceConsts.VOLUME_UP + group));
          logger.debug("Sending volume up command {}",SonanceConsts.VOLUME_UP);
        }
 else {
          outToServer.write(hexStringToByteArray(SonanceConsts.VOLUME_DOWN + group));
          logger.debug("Sending volume down command {}",SonanceConsts.VOLUME_DOWN);
        }
        i.read(cbuf,0,50);
        m=volumePattern.matcher(new String(cbuf));
        if (m.find()) {
          currentVolume=Integer.parseInt(m.group(1));
          logger.info("Setting volume, current volume: {}",currentVolume);
          eventPublisher.postUpdate(itemName,new DecimalType(currentVolume));
        }
 else {
          logger.error("Error sending volume command, received this: {}",new String(cbuf));
        }
      }
    }
 else {
      logger.error("Error sending volume command, received this: {}",new String(cbuf));
    }
  }
  finally {
    volumeLocks.get(lockKey).unlock();
  }
}

{
  broadcaster.getBroadcasterConfig().addFilter(new PerRequestBroadcastFilter(){
    private volatile Object firedObject=new Object();
    ObjectMapper mapper=new ObjectMapper();
    @Override public BroadcastAction filter(    AtmosphereResource resource,    Object originalMessage,    Object message){
      HttpServletRequest request=resource.getRequest();
      try {
synchronized (firedObject) {
          String firedResponse=firedObject instanceof Response ? mapper.writeValueAsString(((Response)firedObject).getEntity()) : "";
          Response response=null;
          if (isStreamingTransport(request)) {
            if (message instanceof Item) {
              response=(Response)getSingleResponseObject((Item)message,request);
            }
 else             return new BroadcastAction(ACTION.ABORT,message);
          }
 else {
            response=(Response)getResponseObject(request);
          }
          String newResponse=mapper.writeValueAsString(response.getEntity());
          if (!newResponse.equals(firedResponse)) {
            firedObject=response;
            return new BroadcastAction(ACTION.CONTINUE,response);
          }
        }
      }
 catch (      JsonGenerationException e) {
        logger.error(e.getMessage());
      }
catch (      JsonMappingException e) {
        logger.error(e.getMessage());
      }
catch (      IOException e) {
        logger.error(e.getMessage());
      }
      return new BroadcastAction(ACTION.ABORT,message);
    }
    @Override public BroadcastAction filter(    Object originalMessage,    Object message){
      return new BroadcastAction(ACTION.CONTINUE,message);
    }
  }
);
  stateChangeListener=new StateChangeListener(){
    public void stateUpdated(    Item item,    State state){
      if (item instanceof GroupItem && !broadcaster.getAtmosphereResources().isEmpty()) {
        broadcaster.broadcast(item);
      }
    }
    public void stateChanged(    final Item item,    State oldState,    State newState){
      if (!broadcaster.getAtmosphereResources().isEmpty()) {
        broadcaster.broadcast(item);
      }
    }
  }
;
  registerStateChangeListenerOnRelevantItems(broadcaster.getID(),stateChangeListener);
}

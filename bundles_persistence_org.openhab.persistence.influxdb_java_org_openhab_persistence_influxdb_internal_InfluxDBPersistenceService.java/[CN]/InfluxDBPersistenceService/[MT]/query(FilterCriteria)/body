{
  Integer pageSize=null;
  Integer pageNumber=null;
  logger.debug("got a query");
  if (!isProperlyConfigured) {
    return Collections.emptyList();
  }
  if (!isConnected()) {
    connect();
  }
  if (!isConnected()) {
    return Collections.emptyList();
  }
  StringBuffer query=new StringBuffer();
  query.append("select ");
  query.append(VALUE_COLUMN_NAME);
  query.append(", ");
  query.append(TIME_COLUMN_NAME);
  query.append(" ");
  query.append("from ");
  if (filter.getItemName() != null) {
    query.append(filter.getItemName());
  }
 else {
    query.append("/.*/");
  }
  if (filter.getState() != null || filter.getOperator() != null || filter.getBeginDate() != null || filter.getEndDate() != null) {
    query.append(" where ");
    boolean foundState=false;
    boolean foundBeginDate=false;
    if (filter.getState() != null && filter.getOperator() != null) {
      String value=stateToString(filter.getState());
      if (value != null) {
        foundState=true;
        query.append(VALUE_COLUMN_NAME);
        query.append(" ");
        query.append(filter.getOperator().toString());
        query.append(" ");
        query.append(value);
      }
    }
    if (filter.getBeginDate() != null) {
      foundBeginDate=true;
      if (foundState) {
        query.append(" and");
      }
      query.append(" ");
      query.append(TIME_COLUMN_NAME);
      query.append(" > '");
      query.append(dateFormat.format(filter.getBeginDate()));
      query.append("'");
    }
    if (filter.getEndDate() != null) {
      if (foundState || foundBeginDate) {
        query.append(" and");
      }
      query.append(" ");
      query.append(TIME_COLUMN_NAME);
      query.append(" < '");
      query.append(dateFormat.format(filter.getEndDate().getTime()));
      query.append("'");
    }
    if (filter.getOrdering() == Ordering.ASCENDING) {
      query.append(" order asc");
    }
    if (filter.getPageSize() != 0) {
      logger.debug("got page size {}",filter.getPageSize());
      pageSize=filter.getPageSize();
    }
    if (filter.getPageNumber() != 0) {
      logger.debug("got page number {}",filter.getPageNumber());
      pageNumber=filter.getPageNumber();
    }
  }
  logger.debug("query string: {}",query.toString());
  List<Serie> results=influxDB.Query(dbName,query.toString(),TimeUnit.MILLISECONDS);
  List<HistoricItem> historicItems=new ArrayList<HistoricItem>();
  for (  Serie result : results) {
    String historicItemName=result.getName();
    logger.trace("item name ",historicItemName);
    String[] columns=result.getColumns();
    int timeColumnNum=0;
    int valueColumnNum=0;
    for (int i=0; i < columns.length; i++) {
      String column=columns[i];
      logger.trace("column name: ",column);
      if (column.equals(TIME_COLUMN_NAME)) {
        timeColumnNum=i;
      }
 else       if (column.equals(VALUE_COLUMN_NAME)) {
        valueColumnNum=i;
      }
    }
    Object[][] points=result.getPoints();
    for (int i=0; i < points.length; i++) {
      if (pageSize != null && pageNumber == null && pageSize < i) {
        logger.debug("returning no more points pageSize {} pageNumber {} i {}",pageSize,pageNumber,i);
        break;
      }
      Object[] objects=points[i];
      logger.trace("adding historic item {}: time {} value {}",historicItemName,(Double)objects[timeColumnNum],String.valueOf(objects[valueColumnNum]));
      historicItems.add(new InfluxdbItem(historicItemName,stringToState(String.valueOf(objects[valueColumnNum]),historicItemName),new Date(((Double)objects[timeColumnNum]).longValue())));
      ;
    }
  }
  return historicItems;
}

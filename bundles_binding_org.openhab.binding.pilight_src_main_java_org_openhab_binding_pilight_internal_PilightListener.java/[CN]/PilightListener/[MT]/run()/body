{
  while (running) {
    try {
      Socket socket=connection.getSocket();
      if (!socket.isClosed()) {
        BufferedReader in=new BufferedReader(new InputStreamReader(socket.getInputStream()));
        String line=in.readLine();
        while (running && line != null) {
          if (!StringUtils.isEmpty(line)) {
            if (line.startsWith("{\"config\":{")) {
              connection.setConfig(getInputMapper().readValue(line,Config.class));
              configAction(ConfigModifyAction.ConfigReceived,null);
            }
 else             if (line.equals("1")) {
              connection.getSocket().close();
              throw new IOException("Connection to pilight lost");
            }
 else {
              Status status=getInputMapper().readValue(line,Status.class);
              callback.messageReceived(connection,status);
            }
          }
          line=in.readLine();
        }
      }
    }
 catch (    IOException e) {
      logger.error("Error in pilight listener thread",e);
    }
    reconnect();
  }
  cleanup();
}
